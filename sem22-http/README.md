# Прикладной уровень

Мы научились решать проблему надёжной защищённой доставки сообщений. Теперь вопрос в том, что именно доставлять. Это определяется конечными приложениями такими как браузеры/почтовые клиенты/... Поговорим о наиболее популярном протоколе прикладного уровня -- HTTP, который используется в браузерах и многих других приложениях.

## HTTP

Hypertext Transfer Protocol вырос из задачи каталогизации текстов задолго до интернета. Изначально предназначался для передачи HTML документов, но позже интернет стал сложнее, и им стали передавать скрипты, картинки и так далее. Мы рассмотрим HTTP/1.1, потому что это текстовый формат, и его проще анализировать глазами.

### Пример запроса

С помощью утилиты ``netcat`` можно посылать произвольные запросы.

```
arslan@arslan-zenbook:~$ nc example.org 80   
GET http://example.org HTTP/1.1
Connection: close


HTTP/1.1 200 OK
Age: 585423
Cache-Control: max-age=604800
Content-Type: text/html; charset=UTF-8
Date: Sat, 04 Feb 2023 06:24:08 GMT
Etag: "3147526947+ident"
Expires: Sat, 11 Feb 2023 06:24:08 GMT
Last-Modified: Thu, 17 Oct 2019 07:18:26 GMT
Server: ECS (nyb/1D2F)
Vary: Accept-Encoding
X-Cache: HIT
Content-Length: 1256
Connection: close

<!doctype html>
<html>
<head>
    <title>Example Domain</title>

    <meta charset="utf-8" />
```

### Формат запроса

```
METHOD PATH HTTP_VERSION
HEADER_NAME: HEADER_VALUE (there may be multiple headers)

REQUEST_BODY (optional after blank line)
```

### Формат ответа

```
HTTP_VERSION STATUS_CODE STATUS_MESSAGE
HEADER_NAME: HEADER_VALUE (there may be multiple headers)

RESPONSE_BODY (optional after blank line)
```

### Методы запросов

HTTP методы обозначаются глаголами, которые говорят, какое действие нужно совершить над ресурсом.

Будем называть запрос безопасным, если он не меняет состояние сервера.

Если от повторения запроса несколько раз эффект не меняется, запрос называется идемпотентным. Этот класс очень важен в реальной жизни, потому что нередко приходится повторять запросы несколько раз в случае обрывов сети/таймаутов и других ошибок. О пользе идемпотентности есть хорошая [статья](https://habr.com/en/company/yandex/blog/442762/).

Наконец, передача данных по сети довольно долгая. Да и ресурсы сервера не резиновые, поэтому полезно иметь возможность кэшировать ответы на запросы. Например, в случае новостного сайта можно кэшировать главную страницу на минуту (и тем самым на порядок снизить нарузку на часть бэкенда на нагрузку).


| Метод | Безопасность | Идемпотентный | Кэшируемый |
|--------|------|------------|----------|
| GET    | Да   | Да         | Да       |
| POST   | Нет  | Нет        | Да       |
| PUT    | Нет  | Да         | Нет      |
| PATCH  | Нет  | Нет        | Нет      |
| DELETE | Нет  | Да         | Нет      |

### Заголовки

Заголовки задают дополнительные параметры запроса. Ниже описание некольких наиболее популярных:

* ``Content-Length`` указывает на размер тела.
* ``Content-Type`` указывает на формат тела. ``text/html``, ``application/json`` и так далее.
* ``User-Agent`` идентифицирует программу. В скриптах полезно указывать здесь значение, соответствующее какому-нибудь популярному браузеру, чтобы вас сразу не приняли за бота.
* ``Cache-Control`` и подобные заголовки позволяют управлять кэшированием.
* ``Set-Cookie`` и ``Cookie``. Как говорилось выше, ``HTTP`` не поддерживает состояние, но это может делать браузер с помощью специальных ``cookie`` (для простоты можно считать, что это словарь строк). Клиент отправляет текущие ``cookie`` для данного домена с помощью заголовка ``Cookie``, а сервер может попросить клиента модифицировать свои ``cookie`` с помощью заголовка ``Set-Cookie``. Подробнее ниже.

### Cookies

Cookie позволяют хранить на клиенте состоянии и модифицировать его с помощью HTTP запросов. У пары ключ/значение могут быть разные атрибуты: домен, путь, срок действия и так далее.

Cookie может использоваться для авторизации. Например, можно сохранить id пользователя и временный токен, чтобы не спрашивать у пользователя пароль при каждом действии.

Другое популярное применение это отслеживание действий пользователя. При первом заходе на сайт можно присвоить пользователю уникальный идентификатор и потом смотреть, на какие страницы сайта он ходит и с каких.

На большинстве сайтов в интернете есть реклама. Баннер запрашивается с ресурса рекламной сети, который в ответе может, в частности, вместе с кодом баннера, посылать вам Cookie и принимать их в последующих запросах. Таким образом рекламная сеть знает о большей части ваших передвижений по интернету и может предлагать вам наиболее релевантные объявления. Cookie которые приходят с доменов, отличные от того, который находится в адресной строке браузера, называются Third-Party, и их можно блокировать в настройках.

Cookie могут породить проблемы с приватностью. Поэтому начиная с 2009 года в ЕС требуют, чтобы пользователь явно соглашался на их хранение. 

### Коды ответа

По коду ответа можно быстро понять результат запроса. Например, в жизни часто настраивают мониторинги на 5xx ошибки, чтобы звонить дежурному инженеру в случае технических неполадок.

| Код  | Meaning      | Examples                      |
|------|--------------|-------------------------------|
| 1xx  | Information  | 100 = agree to handle request |
| 2xx  | Success      | 200 = request succeeded       |
| 3xx  | Redirection  | 301 = page moved              |
| 4xx  | Client error | 404 = page not found          |
| 5xx  | Server error | 500 = internal server error   |

### Curl

``curl``  -- стандартная Linux утилита для посылки HTTP запросов. Она позволяет делать произвольные запросы. Простейший пример:

```
curl -v ya.ru
```

* `-XPOST` - тип запроса
* `-H "Header: value"` - заголовки
* `-d {"foo": "bar"}` - тело запроса 
* `-v` - подробный вывод
* `-o` - перенаправление вывода в файл
* `-L` - следовать по перенаправлениям

Продуктовые разработчики, как правило, используют более продвинутые инструменты с графическим интерфейсом такие как Postman.


## REST API

Хотя HTTP и являлся изначально прикладным протоколом, сейчас его часто используют как транспорт для более высокоуровневого взаимодействия. 

API (Application Programming Interface)  -- описание способов взаимодействия систем.

REST (Representational State Transfer)  -- архитектурный стиль API, который используется в вебе. Его основные принципы:

Принципы:
1. Взаимодействие клиента и сервера происходит по некоторому заданному интерфейсу. При этом они не знают внутреннее устройство друг друга. 
2. Сервер не хранит никакой информации о состоянии клиента между запросами (нет сессий, нет истории операций и т.д.)
3. Все взаимодействие происходит через оперирование ресурсами, которые определяются через URL.
4. Ресурсы имеют четкую структуру.
5. URL - уникальный идентификатор ресурса.
6. Взаимодействие с ресурсами происходит через HTTP методы: GET, POST, PUT, DELETE, PATCH и т.д.
7. Сервер сообщает, что и как кешировать

Один из популярных вариантов спецификации  -- [Swagger](https://swagger.io/specification/). Можно поиграться с [сайтом](https://stfpmi.ru/api/) Студсовета. Есть автоматизированные инструменты для генерации клиентов на разных языках программирования по спецификации такого вида.


## HTTP/2

Почему HTTP/1.1 плохо подходит под современные реалии? Сейчас обычно мы загружаем тяжёлый сайт. Это не просто HTML страница, а множество скриптов, изображений и так далее. В самой первой версии HTTP приходилось бы устанавливать на каждый файл заново TCP соединение. Это было совсем дорого, поэтому придумали заголовок ``Keep-alive``, чтобы не разрывать соединение с сервером какое-то время после отправки первого запроса. В HTTP2 было предложено неколько масштабных изменений для решений этой проблемы, вот несколько основных:

* Бинарный -- позволяет лучше сжимать данные
* Несколькое соединений на запрос  -- быстрая параллельная прогрузка ресурсов. * Server Push  -- попросили HTML, сервер превентивно отправил связанные с ним скрипты и картинки.
* Также добавилась приоритизация и сжатие заголовков. 

## Ссылки

https://developer.mozilla.org/ru/docs/Web/HTTP/Overview

https://habr.com/ru/company/nix/blog/304518/

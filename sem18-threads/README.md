# Потоки
 
Зачастую нам бывает нужно что-нибудь параллельно посчитать. В этом случае нам удобно иметь общую память, а для локальных вычислений достаточно своего стека и регистров (и своей обработки сигналов). В таком случае можно говорить о потоках.

Чтобы использовать потоки, нужно при компиляции добавить опцию `-pthread`. 

## Использование POSIX потоков

Запуск потоков осуществляется с помощью системного вызова `pthread_create`.

```
int pthread_create(
    // указатель на переменную-результат
    pthread_t *thread,

    // опционально: параметры нового потока,
    // например размер стека
    // может быть NULL
    const pthread_attr_t *attr,

    // функция, которая будет выполняться
    (void*)(*function)(void*),

    // аргумент, который передается в функцию
    void *arg
);
```

Дождаться завершения можно с помощью `pthread_join`.

```
int pthread_join(
    // поток, который нужно ждать
    pthread_t thread,

    // указатель на результат работы функции,
    // либо NULL, если он не интересен
    (void*) *retval
    );
```

При это `retval` должен быть на куче, потому что стек потока уничтожится после завершения функции.

Измерить ускорение от распараллеливания можно на примере `parallel_sum.c`. Заодно можно поговорить о том, что измеряет команда `time`.
* `real` считает астрономическое время с момента запуска до завершения программы
* `user` считает, сколько времени ваша программа исполнялась на CPU в обычном режиме
* `sys` считает, сколько времени ваша программа исполнялась на CPU в привелигированном режиме (например, в системных вызовах)

Можно позапускать пример на разном числе потоков и заметить, что по `real` достигается почти линейное ускорение в начале. А две других цифры не меняются, потому что объём вычислений остаётся неизменным, они просто распределяются по разным ядрам процессора. Ускорение остановится примерно в тот момент, когда число потоков сравнится с числом потоков процессора.

## Дополнительные возможности

Если результат работы потока вам больше не нужен, можно завершить его с помощью `pthread_cancel`.

```
int pthread_cancel(
    // поток, который нужно прибить
    pthread_t thread
    );
```

Манипуляция аттрибутами потока производится путём создания структуры и вызова сеттеро. Например, размер стека можно менять как-то так.

```
pthread_attr_t thread_attr; 
pthread_attr_init(&thread_attr);
pthread_attr_setstacksize(&thread_attr, MY_STACK_SIZE)
```

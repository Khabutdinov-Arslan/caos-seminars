# Python extending and embedding

Python гораздо больше распространён, чем C. Он используется в вебе, для расчётов, автоматизации процессов и многих других вещей.

Зачем может понадобиться писать библиотеки для него на C?
* Есть большое количество библиотек для C, для которых проще написать адаптер
* Хочется делать что-то низкоуровневое
* Хочется ускорить программу. В частности, на Python из-за GIL тяжело параллелить вычисления.

## Python/C API

Python из C подключается как динамическая библиотека. Она содержит множество методов, подробнее можно почитать в официальной [документации](https://docs.python.org/3/c-api/index.html).

Создание примера базового модуля также хорошо описано в [документации](https://docs.python.org/3/extending/extending.html). Остановимся на основных полезных конструкциях, которые используются в `extend`.

Базовым классом в Python является `object`, поэтому все функции в `C` работают с `PyObject`. Конкретные классы и методы именуются `PyClass_Method`, указатель на объект класса передаётся первым аргументом. `args` распаковываются с помощью `PyArg_ParseTuple`, подробнее про её аргументы можно почитать в [документации](https://docs.python.org/3/c-api/arg.html). Чтобы преобразовать примитивный тип из `Python` в `C` используются конструкции вида `PyTypeAsType`, обратно -- `PyTypeFromType`. Исключения прокидываются с помощью `PyErr_SetString` и возвращения `NULL` из функции.

Для объявления модуля используется `PyInit_Module` (название должно совпадать с названием результирующей разделяемой библиотеки). В нём перечисляется метаинформация о модуле и ссылки на методы. Также модуль нужно добавить в таблицу модулей с помощью `PyImport_AppendInittab`.

## Вызов интерпретатора Python из С

Если по какой-то причине вам понадобилось вызвать интерпретатор `Python` из `C`, нужно всё также подключить `Python.h` в программе. Отправить текст на запуск можно с помощью `PyRun_SimpleFile` или `PyRun_SimpleString`. Перед их использованием нужно не забыть сделать `Py_Initialize`, а после `Py_Finalize`. Пример можно найти в `embed`.
